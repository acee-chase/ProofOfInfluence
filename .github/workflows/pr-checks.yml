name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check if title follows convention
          if [[ $PR_TITLE =~ ^(feat|fix|docs|refactor|chore|style|test)(\(.+\))?: ]]; then
            echo "‚úÖ PR title format correct: $PR_TITLE"
          else
            echo "‚ö†Ô∏è PR title should follow: type(scope): description"
            echo "Example: feat(frontend): add user dashboard"
            echo "Current: $PR_TITLE"
          fi

      - name: Check for large files
        run: |
          # Check if any files > 1MB
          find . -type f -size +1M -not -path "*/node_modules/*" -not -path "*/.git/*" | while read file; do
            echo "‚ö†Ô∏è Large file detected: $file"
          done

      - name: Check for secrets
        run: |
          # Simple check for potential secrets (not foolproof)
          if grep -r "sk_live_\|sk_test_\|pk_live_\|pk_test_" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "‚ùå Potential secret detected in code!"
            exit 1
          else
            echo "‚úÖ No obvious secrets found"
          fi

      - name: Count changed files
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)
          echo "üìä Files changed: $CHANGED"
          
          if [ $CHANGED -gt 50 ]; then
            echo "‚ö†Ô∏è Large PR detected ($CHANGED files). Consider splitting."
          fi

      - name: PR Info Summary
        run: |
          echo "## PR Summary"
          echo "- **Title**: ${{ github.event.pull_request.title }}"
          echo "- **Author**: ${{ github.event.pull_request.user.login }}"
          echo "- **Base**: ${{ github.event.pull_request.base.ref }}"
          echo "- **Head**: ${{ github.event.pull_request.head.ref }}"
          echo "- **Files Changed**: $(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)"

  file-changes-report:
    name: File Changes Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Categorize changes
        run: |
          echo "## üìÇ File Changes by Category"
          echo ""
          
          # Frontend changes
          FRONTEND=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep "^client/" | wc -l)
          echo "üé® Frontend: $FRONTEND files"
          
          # Backend changes
          BACKEND=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep "^server/" | wc -l)
          echo "‚öôÔ∏è Backend: $BACKEND files"
          
          # Contract changes
          CONTRACTS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep "^contracts/" | wc -l)
          echo "üìú Contracts: $CONTRACTS files"
          
          # Docs changes
          DOCS=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E "\.md$|^docs/" | wc -l)
          echo "üìö Docs: $DOCS files"

